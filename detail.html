<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细信息</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>详细信息</h1>
            <nav>
                <a href="index.html">上传</a>
                <a href="list.html">列表</a>
                <a href="detail.html" class="active">详情</a>
            </nav>
        </header>

        <main>
            <div class="detail-section">
                <div class="back-button">
                    <button onclick="window.history.back()">返回列表</button>
                </div>
                
                <div class="detail-card">
                    <h2>基本信息</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>姓名:</label>
                            <span id="detailName"></span>
                        </div>
                        <div class="info-item">
                            <label>手机号:</label>
                            <span id="detailPhone"></span>
                        </div>
                        <div class="info-item">
                            <label>身份证号:</label>
                            <span id="detailIdCard"></span>
                        </div>
                        <div class="info-item">
                            <label>评分结果:</label>
                            <span id="detailScore" class="score-badge"></span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h2>评分分布饼图</h2>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend">
                        <!-- 图例将通过JavaScript生成 -->
                    </div>
                </div>
                <div class="score-radar">
                    <h3>六维度评分图</h3>
                    <canvas id="radarChart" width="400" height="400"></canvas>
                </div>
            </div>
            <div class="dimension-details">
                <h3>各维度评分详情</h3>
                <div class="dimensions-grid">
                    <div class="dimension-item">
                        <h4>消费能力</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="consumptionFill"></div>
                        </div>
                        <span class="dimension-score" id="consumptionScore"></span>
                    </div>        
                    <div class="dimension-item">
                        <h4>通讯活跃</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="communicationFill"></div>
                        </div>
                        <span class="dimension-score" id="communicationScore"></span>                        
                    </div>
                    <div class="dimension-item">
                        <h4>工作稳定</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="stabilityFill"></div>
                        </div>
                        <span class="dimension-score" id="stabilityScore"></span>
                    </div>
                        
                    <div class="dimension-item">
                        <h4>资产状况</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="assetsFill"></div>
                        </div>
                        <span class="dimension-score" id="assetsScore"></span>
                    </div>
                        
                    <div class="dimension-item">
                        <h4>信贷活跃</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="creditFill"></div>
                        </div>
                        <span class="dimension-score" id="creditScore"></span>
                    </div>
                        
                    <div class="dimension-item">
                        <h4>居住稳定</h4>
                        <div class="score-bar">
                            <div class="score-fill" id="residenceFill"></div>
                        </div>
                        <span class="dimension-score" id="residenceScore"></span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
    <script>
        // 加载并显示详细信息
        document.addEventListener('DOMContentLoaded', function() {
            const storedData = localStorage.getItem('excelData');
            const selectedIndex = localStorage.getItem('selectedIndex');
            
            if (!storedData || selectedIndex === null) {
                alert('没有找到数据，请从列表中选择一个项目');
                window.location.href = 'list.html';
                return;
            }
            
            const data = JSON.parse(storedData);
            const selectedItem = data[selectedIndex];
            
            if (!selectedItem) {
                alert('所选数据不存在');
                window.location.href = 'list.html';
                return;
            }
            
            displayDetails(selectedItem);
            renderPieChart(selectedItem.score);
        });

        function displayDetails(item) {
            document.getElementById('detailName').textContent = item.name;
            document.getElementById('detailPhone').textContent = item.phone;
            document.getElementById('detailIdCard').textContent = maskIdCard(item.idCard);
            
            const scoreElement = document.getElementById('detailScore');
            scoreElement.textContent = item.score.toFixed(2);
            
            // 根据评分设置颜色
            if (item.score >= 0.8) {
                scoreElement.classList.add('score-high');
            } else if (item.score >= 0.5) {
                scoreElement.classList.add('score-medium');
            } else {
                scoreElement.classList.add('score-low');
            }
        }

        function renderPieChart(score) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            // 生成6个随机百分比，总和为100%
            const percentages = generateRandomPercentages(6);
            
            // 饼图数据
            const data = {
                labels: ['电子类消费', '服饰类消费', '娱乐性消费', 
                '餐饮类消费', '旅游类消费', '其他消费'
                ],
                datasets: [{
                    data: percentages,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', 
                        '#4BC0C0', '#9966FF', '#FF9F40'
                    ],
                    borderWidth: 1
                }]
            };
            
            // 创建饼图
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 更新图例
            updateLegend(percentages);
        }

        function generateRandomPercentages(count) {
            const numbers = [];
            let sum = 0;
            
            // 生成随机数
            for (let i = 0; i < count; i++) {
                numbers.push(Math.random());
                sum += numbers[i];
            }
            
            // 标准化为百分比
            return numbers.map(num => 
                Math.round((num / sum) * 100)
            );
        }

        function updateLegend(percentages) {
            const labels = [
                '电子类消费', '服饰类消费', '娱乐性消费', 
                '餐饮类消费', '旅游类消费', '其他消费'
            ];
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', 
                '#4BC0C0', '#9966FF', '#FF9F40'
            ];
            
            const legendHtml = labels.map((label, index) => `
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[index]}"></span>
                    <span class="legend-label">${label}: ${percentages[index]}%</span>
                </div>
            `).join('');
            
            document.getElementById('chartLegend').innerHTML = legendHtml;
        }

        function maskIdCard(idCard) {
            if (idCard.length <= 8) return idCard;
            return idCard.substring(0, 4) + '********' + idCard.substring(idCard.length - 4);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.getElementById('backButton');
            const loading = document.getElementById('loading');
            const detailContent = document.getElementById('detailContent');
            
            // 返回列表页面
            backButton.addEventListener('click', () => {
                window.location.href = 'list.html';
            });
            
            // 从sessionStorage获取数据
            const scoredData = JSON.parse(sessionStorage.getItem('scoredData') || '[]');
            const selectedIndex = sessionStorage.getItem('selectedIndex');
            
            if (scoredData.length === 0 || !selectedIndex) {
                alert('没有找到数据，请返回列表页面重新选择');
                window.location.href = 'list.html';
                return;
            }
            
            const selectedData = scoredData[selectedIndex];
            
            // 生成六个维度的随机分数（基于总分的加权随机）
            function generateDimensionScores(totalScore) {
                const baseScore = totalScore / 850 * 100; // 转换为百分比基础
                
                return {
                    consumption: Math.floor(Math.random() * 20 + baseScore * 0.8),
                    communication: Math.floor(Math.random() * 20 + baseScore * 0.7),
                    stability: Math.floor(Math.random() * 20 + baseScore * 0.9),
                    assets: Math.floor(Math.random() * 20 + baseScore * 0.85),
                    credit: Math.floor(Math.random() * 20 + baseScore * 0.75),
                    residence: Math.floor(Math.random() * 20 + baseScore * 0.95)
                };
            }
            
            const dimensionScores = generateDimensionScores(selectedData.score);
            
            // 更新页面信息
            document.getElementById('userName').textContent = selectedData.name;
            document.getElementById('userPhone').textContent = selectedData.phone;
            document.getElementById('userIdCard').textContent = selectedData.idCard;
            document.getElementById('totalScore').textContent = selectedData.score;
            
            // 更新各维度评分
            Object.keys(dimensionScores).forEach(dimension => {
                const score = dimensionScores[dimension];
                document.getElementById(`${dimension}Score`).textContent = score;
                document.getElementById(`${dimension}Fill`).style.width = `${score}%`;
            });
            
            // 绘制雷达图
            const ctx = document.getElementById('radarChart').getContext('2d');
            const radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['消费能力', '通讯活跃', '工作稳定', '资产状况', '信贷活跃', '居住稳定'],
                    datasets: [{
                        label: '维度评分',
                        data: [
                            dimensionScores.consumption,
                            dimensionScores.communication,
                            dimensionScores.stability,
                            dimensionScores.assets,
                            dimensionScores.credit,
                            dimensionScores.residence
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            min: 0
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.2
                        }
                    }
                }
            });
            
            // 隐藏加载提示，显示内容
            loading.style.display = 'none';
            detailContent.style.display = 'block';
        });
    </script>
</body>
</html>
