<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ•°æ®ä¸Šä¼ </title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Excelæ•°æ®ä¸Šä¼ è§£æç³»ç»Ÿ</h1>
            <nav>
                <a href="index.html" class="active">ä¸Šä¼ </a>
                <a href="list.html">åˆ—è¡¨</a>
                <a href="detail.html">è¯¦æƒ…</a>
            </nav>
        </header>

        <main>
            <div class="upload-section">
                <h2>ä¸Šä¼ Excelæ–‡ä»¶</h2>
                <p>è¯·é€‰æ‹©åŒ…å«ä¸‰åˆ—(å§“åã€æ‰‹æœºå·ã€èº«ä»½è¯å·)çš„Excelæ–‡ä»¶</p>
                
                <div class="upload-box" id="dropArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
                    <div class="upload-placeholder">
                        <span class="upload-icon">ğŸ“</span>
                        <p>æ‹–æ”¾Excelæ–‡ä»¶åˆ°è¿™é‡Œæˆ–</p>
                        <button onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                    <div class="upload-progress" id="progressBar" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress"></div>
                        </div>
                        <p>è§£æä¸­...</p>
                    </div>
                </div>
                
                <div class="requirements">
                    <h3>æ–‡ä»¶è¦æ±‚:</h3>
                    <ul>
                        <li>æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</li>
                        <li>å¿…é¡»åŒ…å«ä¸‰åˆ—: å§“åã€æ‰‹æœºå·ã€èº«ä»½è¯å·</li>
                        <li>ç¬¬ä¸€è¡Œåº”ä¸ºæ ‡é¢˜è¡Œ</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†é€»è¾‘
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.getElementById('progressBar');
        const uploadPlaceholder = document.querySelector('.upload-placeholder');

        // æ‹–æ”¾åŠŸèƒ½
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        // æ–‡ä»¶å¤„ç†
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFile, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                handleFiles(files[0]);
            }
        }

        function handleFile(e) {
            const files = e.target.files;
            if (files.length) {
                handleFiles(files[0]);
            }
        }

        function handleFiles(file) {
            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadPlaceholder.style.display = 'none';
            progressBar.style.display = 'block';
            
            // è§£æExcel
            setTimeout(() => {
                parseExcelFile(file);
            }, 500);
        }

        function parseExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: ['name', 'phone', 'idCard'] });
                    
                    // ç§»é™¤æ ‡é¢˜è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (jsonData.length > 0 && typeof jsonData[0].name === 'string' && 
                        (jsonData[0].name === 'å§“å' || jsonData[0].name === 'name')) {
                        jsonData.shift();
                    }
                    
                    // éªŒè¯æ•°æ®
                    const validData = jsonData.filter(row => 
                        row.name && row.phone && row.idCard &&
                        isValidPhone(row.phone) &&
                        isValidIdCard(row.idCard)
                    );
                    
                    // æ·»åŠ éšæœºè¯„åˆ†
                    const processedData = validData.map(row => ({
                        ...row,
                        score: generateRandomScore()
                    }));
                    
                    // å­˜å‚¨æ•°æ®å¹¶è·³è½¬åˆ°åˆ—è¡¨é¡µ
                    localStorage.setItem('excelData', JSON.stringify(processedData));
                    window.location.href = 'list.html';
                    
                } catch (error) {
                    progressBar.style.display = 'none';
                    uploadPlaceholder.style.display = 'block';
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                progressBar.style.display = 'none';
                uploadPlaceholder.style.display = 'block';
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // è¾…åŠ©å‡½æ•°
        function isValidPhone(phone) {
            return /^1[3-9]\d{9}$/.test(phone.toString().trim());
        }

        function isValidIdCard(idCard) {
            const str = idCard.toString().trim();
            return /(^\d{15}$)|(^\d{17}(\d|X|x)$)/.test(str);
        }

        function generateRandomScore() {
            return Math.round(Math.random() * 100) / 100;
        }
    </script>
</body>
</html>
