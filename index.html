<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel数据上传</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Excel数据上传解析系统</h1>
            <nav>
                <a href="index.html" class="active">上传</a>
                <a href="list.html">列表</a>
                <a href="detail.html">详情</a>
            </nav>
        </header>

        <main>
            <div class="upload-section">
                <h2>上传Excel文件</h2>
                <p>请选择包含三列(姓名、手机号、身份证号)的Excel文件</p>
                
                <div class="upload-box" id="dropArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
                    <div class="upload-placeholder">
                        <span class="upload-icon">📁</span>
                        <p>拖放Excel文件到这里或</p>
                        <button onclick="document.getElementById('fileInput').click()">选择文件</button>
                    </div>
                    <div class="upload-progress" id="progressBar" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress"></div>
                        </div>
                        <p>解析中...</p>
                    </div>
                </div>
                
                <div class="requirements">
                    <h3>文件要求:</h3>
                    <ul>
                        <li>支持.xlsx和.xls格式</li>
                        <li>必须包含三列: 姓名、手机号、身份证号</li>
                        <li>第一行应为标题行</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // 文件上传处理逻辑
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.getElementById('progressBar');
        const uploadPlaceholder = document.querySelector('.upload-placeholder');

        // 拖放功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        // 文件处理
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFile, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                handleFiles(files[0]);
            }
        }

        function handleFile(e) {
            const files = e.target.files;
            if (files.length) {
                handleFiles(files[0]);
            }
        }

        function handleFiles(file) {
            // 显示进度条
            uploadPlaceholder.style.display = 'none';
            progressBar.style.display = 'block';
            
            // 解析Excel
            setTimeout(() => {
                parseExcelFile(file);
            }, 500);
        }

        function parseExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: ['name', 'phone', 'idCard'] });
                    
                    // 移除标题行（如果存在）
                    if (jsonData.length > 0 && typeof jsonData[0].name === 'string' && 
                        (jsonData[0].name === '姓名' || jsonData[0].name === 'name')) {
                        jsonData.shift();
                    }
                    
                    // 验证数据
                    const validData = jsonData.filter(row => 
                        row.name && row.phone && row.idCard &&
                        isValidPhone(row.phone) &&
                        isValidIdCard(row.idCard)
                    );
                    
                    // 添加随机评分
                    const processedData = validData.map(row => ({
                        ...row,
                        score: generateRandomScore()
                    }));
                    
                    // 存储数据并跳转到列表页
                    localStorage.setItem('excelData', JSON.stringify(processedData));
                    window.location.href = 'list.html';
                    
                } catch (error) {
                    progressBar.style.display = 'none';
                    uploadPlaceholder.style.display = 'block';
                    alert('文件解析失败: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                progressBar.style.display = 'none';
                uploadPlaceholder.style.display = 'block';
                alert('文件读取失败');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 辅助函数
        function isValidPhone(phone) {
            return /^1[3-9]\d{9}$/.test(phone.toString().trim());
        }

        function isValidIdCard(idCard) {
            const str = idCard.toString().trim();
            return /(^\d{15}$)|(^\d{17}(\d|X|x)$)/.test(str);
        }

        function generateRandomScore() {
            return Math.round(Math.random() * 100) / 100;
        }
    </script>
</body>
</html>
