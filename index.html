<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel解析与评分系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入SheetJS用于解析Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 引入Chart.js用于绘制雷达图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        accent: '#10b981',
                        neutral: '#f1f5f9',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .page-transition {
                transition: all 0.3s ease-in-out;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md fixed w-full top-0 z-50 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-primary flex items-center">
                        <i class="fa fa-file-excel-o mr-2"></i>
                        <span>Excel解析与评分系统</span>
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-upload" class="px-3 py-2 rounded-md text-sm font-medium text-primary border-b-2 border-primary">
                        <i class="fa fa-upload mr-1"></i>上传文件
                    </button>
                    <button id="nav-list" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-primary transition-colors hidden">
                        <i class="fa fa-list mr-1"></i>数据列表
                    </button>
                    <button id="nav-detail" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-primary transition-colors hidden">
                        <i class="fa fa-user mr-1"></i>详情信息
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16 min-h-screen">
        <!-- 1. 上传文件页面 -->
        <section id="upload-page" class="page-transition">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-xl p-8 card-shadow transform hover:scale-[1.01] transition-transform">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">上传Excel文件</h2>
                    
                    <div class="mb-6 text-center text-gray-600">
                        <p>请上传包含以下三列信息的Excel文件：</p>
                        <div class="flex justify-center mt-2 space-x-6">
                            <span class="flex items-center"><i class="fa fa-check-circle text-accent mr-1"></i>姓名</span>
                            <span class="flex items-center"><i class="fa fa-check-circle text-accent mr-1"></i>手机号</span>
                            <span class="flex items-center"><i class="fa fa-check-circle text-accent mr-1"></i>身份证号</span>
                        </div>
                    </div>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer" id="drop-area">
                        <i class="fa fa-file-excel-o text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">拖放Excel文件到此处，或</p>
                        <label class="bg-primary text-white px-6 py-3 rounded-md inline-block hover:bg-primary/90 transition-colors cursor-pointer">
                            <i class="fa fa-folder-open mr-2"></i>选择文件
                            <input type="file" id="file-input" accept=".xlsx, .xls" class="hidden">
                        </label>
                    </div>
                    
                    <div id="file-info" class="mt-6 hidden">
                        <div class="bg-neutral p-4 rounded-lg flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-file-text-o text-primary mr-3"></i>
                                <span id="file-name" class="text-gray-700 truncate max-w-md"></span>
                            </div>
                            <button id="remove-file" class="text-red-500 hover:text-red-700 transition-colors">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button id="parse-btn" class="bg-accent text-white px-8 py-3 rounded-md font-medium hover:bg-accent/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-cog mr-2"></i>解析文件
                        </button>
                    </div>
                    
                    <div id="loading" class="mt-6 text-center hidden">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                        <p class="mt-2 text-gray-600">正在解析文件，请稍候...</p>
                    </div>
                    
                    <div id="error-message" class="mt-6 p-4 bg-red-50 border border-red-200 rounded-md text-red-600 hidden">
                        <i class="fa fa-exclamation-circle mr-2"></i>
                        <span id="error-text"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. 数据列表页面 -->
        <section id="list-page" class="page-transition hidden">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fa fa-list-alt text-primary mr-2"></i>数据列表
                    </h2>
                    <div class="text-gray-600">
                        <span id="total-count" class="font-medium text-primary"></span>
                        <span>条记录</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手机号</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">身份证号</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    评分结果
                                    <i class="fa fa-sort-desc text-primary ml-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- 数据行会通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-data-message" class="py-16 text-center hidden">
                    <i class="fa fa-inbox text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">暂无数据，请先上传并解析Excel文件</p>
                </div>
            </div>
        </section>

        <!-- 3. 详情页面 -->
        <section id="detail-page" class="page-transition hidden">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fa fa-user-circle text-primary mr-2"></i>个人详情
                    </h2>
                    <button id="back-to-list" class="text-primary hover:text-primary/80 transition-colors flex items-center">
                        <i class="fa fa-arrow-left mr-1"></i>
                        返回列表
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- 个人信息 -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">基本信息</h3>
                        <div class="space-y-4">
                            <div class="flex">
                                <span class="w-1/3 text-gray-500">姓名：</span>
                                <span id="detail-name" class="w-2/3 font-medium"></span>
                            </div>
                            <div class="flex">
                                <span class="w-1/3 text-gray-500">手机号：</span>
                                <span id="detail-phone" class="w-2/3 font-medium"></span>
                            </div>
                            <div class="flex">
                                <span class="w-1/3 text-gray-500">身份证号：</span>
                                <span id="detail-idcard" class="w-2/3 font-medium"></span>
                            </div>
                            <div class="flex">
                                <span class="w-1/3 text-gray-500">综合评分：</span>
                                <span id="detail-score" class="w-2/3 font-medium text-primary"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 评分雷达图 -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">评分维度分析</h3>
                        <div class="flex justify-center">
                            <div class="w-full max-w-md h-80">
                                <canvas id="radar-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">消费能力</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">通讯活跃</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">工作稳定</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">资产状况</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">信贷活跃</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                                <span class="text-sm text-gray-600">居住稳定</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                © 2023 Excel解析与评分系统 | 设计与开发
            </p>
        </div>
    </footer>

    <script>
        // 全局变量
        let excelData = [];
        let currentRecord = null;
        let radarChart = null;
        // 用于防止文件选择框重复弹出的标志
        let isFileDialogOpen = false;
        
        // DOM元素
        const pages = {
            upload: document.getElementById('upload-page'),
            list: document.getElementById('list-page'),
            detail: document.getElementById('detail-page')
        };
        
        const navButtons = {
            upload: document.getElementById('nav-upload'),
            list: document.getElementById('nav-list'),
            detail: document.getElementById('nav-detail')
        };
        
        const fileInput = document.getElementById('file-input');
        const dropArea = document.getElementById('drop-area');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const removeFile = document.getElementById('remove-file');
        const parseBtn = document.getElementById('parse-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dataTableBody = document.getElementById('data-table-body');
        const totalCount = document.getElementById('total-count');
        const noDataMessage = document.getElementById('no-data-message');
        const backToList = document.getElementById('back-to-list');
        
        // 详情页元素
        const detailName = document.getElementById('detail-name');
        const detailPhone = document.getElementById('detail-phone');
        const detailIdcard = document.getElementById('detail-idcard');
        const detailScore = document.getElementById('detail-score');
        
        // 页面切换函数
        function showPage(pageName) {
            // 隐藏所有页面
            Object.values(pages).forEach(page => {
                page.classList.add('hidden');
            });
            
            // 重置所有导航按钮样式
            Object.values(navButtons).forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btn.classList.add('text-gray-600');
            });
            
            // 显示目标页面和激活对应导航
            pages[pageName].classList.remove('hidden');
            navButtons[pageName].classList.remove('text-gray-600');
            navButtons[pageName].classList.add('text-primary', 'border-b-2', 'border-primary');
            
            // 对于列表和详情页，显示对应的导航按钮
            if (pageName === 'list' || pageName === 'detail') {
                navButtons.upload.classList.remove('hidden');
                navButtons.list.classList.remove('hidden');
            } else {
                navButtons.list.classList.add('hidden');
                navButtons.detail.classList.add('hidden');
            }
            
            if (pageName === 'detail') {
                navButtons.detail.classList.remove('hidden');
            } else {
                navButtons.detail.classList.add('hidden');
            }
        }
        
        // 导航按钮事件
        navButtons.upload.addEventListener('click', () => showPage('upload'));
        navButtons.list.addEventListener('click', () => showPage('list'));
        navButtons.detail.addEventListener('click', () => showPage('detail'));
        backToList.addEventListener('click', () => showPage('list'));
        
        // 文件上传相关事件 - 修复弹出两次的问题
        fileInput.addEventListener('change', handleFileSelect);
        
        // 修复：添加input事件监听，重置文件选择框状态
        fileInput.addEventListener('input', () => {
            isFileDialogOpen = false;
        });
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('border-primary');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('border-primary');
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-primary');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e);
            }
        });
        
        // 修复：防止点击事件冒泡导致的重复触发
        dropArea.addEventListener('click', (e) => {
            // 只有在文件对话框未打开时才触发
            if (!isFileDialogOpen) {
                isFileDialogOpen = true;
                fileInput.click();
                // 防止事件冒泡
                e.stopPropagation();
            }
        });
        
        // 为label添加点击事件处理，防止重复触发
        const fileLabel = dropArea.querySelector('label');
        fileLabel.addEventListener('click', (e) => {
            if (!isFileDialogOpen) {
                isFileDialogOpen = true;
                // 防止事件冒泡到dropArea
                e.stopPropagation();
            }
        });
        
        removeFile.addEventListener('click', () => {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            parseBtn.disabled = true;
        });
        
        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // 验证文件类型
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    fileName.textContent = file.name;
                    fileInfo.classList.remove('hidden');
                    parseBtn.disabled = false;
                    errorMessage.classList.add('hidden');
                } else {
                    showError('请上传Excel文件（.xlsx 或 .xls 格式）');
                    fileInput.value = '';
                }
            }
            // 重置标志
            isFileDialogOpen = false;
        }
        
        // 解析Excel文件
        parseBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) return;
            
            // 显示加载状态
            loading.classList.remove('hidden');
            parseBtn.disabled = true;
            errorMessage.classList.add('hidden');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // 解析Excel文件
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 验证数据格式
                    if (jsonData.length === 0) {
                        throw new Error('Excel文件中没有数据');
                    }
                    
                    // 检查列是否正确（这里假设列名是"姓名"、"手机号"、"身份证号"）
                    const firstRow = jsonData[0];
                    const requiredColumns = ['姓名', '手机号', '身份证号'];
                    const missingColumns = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));
                    
                    if (missingColumns.length > 0) {
                        throw new Error(`Excel文件缺少必要的列：${missingColumns.join('、')}`);
                    }
                    
                    // 处理数据，生成评分
                    excelData = jsonData.map(item => {
                        // 生成300-850之间的随机评分
                        const score = Math.floor(Math.random() * (850 - 300 + 1)) + 300;
                        
                        // 生成六个维度的评分（0-100）
                        const dimensions = generateDimensions(score);
                        
                        return {
                            name: item['姓名'],
                            phone: item['手机号'],
                            idcard: item['身份证号'],
                            score: score,
                            dimensions: dimensions
                        };
                    });
                    
                    // 按评分降序排序
                    excelData.sort((a, b) => b.score - a.score);
                    
                    // 更新列表
                    renderDataList();
                    
                    // 切换到列表页
                    showPage('list');
                    
                } catch (error) {
                    showError(error.message);
                } finally {
                    // 隐藏加载状态
                    loading.classList.add('hidden');
                    parseBtn.disabled = false;
                }
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // 根据总评分生成六个维度的分数（0-100）
        function generateDimensions(totalScore) {
            // 将300-850的分数映射到0-100
            const baseScore = Math.round(((totalScore - 300) / (850 - 300)) * 100);
            
            // 六个维度：消费能力，通讯活跃，工作稳定，资产状况，信贷活跃，居住稳定
            return {
                '消费能力': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10))),
                '通讯活跃': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10))),
                '工作稳定': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10))),
                '资产状况': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10))),
                '信贷活跃': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10))),
                '居住稳定': Math.max(0, Math.min(100, baseScore + (Math.random() * 20 - 10)))
            };
        }
        
        // 渲染数据列表
        function renderDataList() {
            // 清空表格
            dataTableBody.innerHTML = '';
            
            if (excelData.length === 0) {
                noDataMessage.classList.remove('hidden');
                totalCount.textContent = '0';
                return;
            }
            
            noDataMessage.classList.add('hidden');
            totalCount.textContent = excelData.length;
            
            // 添加数据行
            excelData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors cursor-pointer';
                row.addEventListener('click', () => showDetail(index));
                
                // 格式化身份证号，只显示前6位和后4位
                const formattedIdcard = item.idcard.length >= 10 
                    ? item.idcard.substr(0, 6) + '********' + item.idcard.substr(-4)
                    : item.idcard;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${item.phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${formattedIdcard}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium ${getScoreColorClass(item.score)}">${item.score}</div>
                    </td>
                `;
                
                dataTableBody.appendChild(row);
            });
        }
        
        // 根据分数获取颜色类
        function getScoreColorClass(score) {
            if (score >= 700) return 'text-green-600';
            if (score >= 500) return 'text-blue-600';
            return 'text-orange-600';
        }
        
        // 显示详情页
        function showDetail(index) {
            currentRecord = excelData[index];
            if (!currentRecord) return;
            
            // 更新详情页数据
            detailName.textContent = currentRecord.name;
            detailPhone.textContent = currentRecord.phone;
            detailIdcard.textContent = currentRecord.idcard;
            detailScore.textContent = currentRecord.score;
            detailScore.className = `w-2/3 font-medium ${getScoreColorClass(currentRecord.score)}`;
            
            // 绘制雷达图
            renderRadarChart(currentRecord.dimensions);
            
            // 切换到详情页
            showPage('detail');
        }
        
        // 绘制雷达图 - 优化渲染性能
        function renderRadarChart(dimensions) {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            
            // 如果已有图表，先销毁
            if (radarChart) {
                radarChart.destroy();
            }
            
            // 准备数据
            const labels = Object.keys(dimensions);
            const data = Object.values(dimensions);
            
            // 创建雷达图 - 优化动画性能
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '评分',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }]
                },
                options: {
                    // 优化渲染性能
                    animation: {
                        duration: 500, // 缩短动画时间
                        easing: 'linear' // 使用更简单的动画曲线
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                stepSize: 20, // 6等分（0-100）
                                backdropColor: 'transparent'
                            },
                            // 减少绘制复杂度
                            grid: {
                                drawOnChartArea: true,
                                drawTicks: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${Math.round(context.raw)}分`;
                                }
                            }
                        }
                    },
                    // 禁用不必要的交互以提高性能
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                }
            });
        }
        
        // 显示错误信息
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // 初始显示上传页面
        showPage('upload');
    </script>
</body>
</html>
